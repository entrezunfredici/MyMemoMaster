<template>
  <div>
    <section>Salut salut</section>

    <section>
      <DiagramTest />
    </section>
    Salut salut

    <section>
      <Dropdown name="Trier" side="right"> Salut salut </Dropdown>

      <Button>Tesst</Button>
    </section>

    <section>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
      <p>
        Lorem ipsum dolor, sit amet consectetur adipisicing elit. Quam ut dolore, omnis iure
        voluptatem libero accusamus itaque sequi optio? Iste, fugiat. Quis corporis nemo quibusdam
        iusto, saepe neque excepturi vel.
      </p>
    </section>

    <section>Salut salut</section>
    <section>
      <DiagramTest />
    </section>
    <section>
      <DiagramTest />
    </section>
    <section>
      <h2>Symboles Disponibles</h2>
      <!-- Utilisation du composant de la palette -->
      <SymbolPalette @symbolClicked="addToInput" />
    </section>
    <section>
      <h2>Interpréteur de Formules</h2>
      <p>Déplacez un bloc dans la zone ci-dessous pour voir sa conversion.</p>

      <!-- Zone d'interprétation -->
      <textarea v-model="userInput" rows="5" cols="50" @keydown.delete="handleDelete"></textarea>

      <h3>Résultat :</h3>
      <Interpreter :content="interpretedContent" />
    </section>
  </div>
</template>

<script setup>
import DiagramTest from '@/components/DiagramTestComponent.vue'
import Button from '@/components/ButtonComponent.vue'
import Dropdown from '@/components/DropdownComponent.vue'
import Interpreter from '@/components/Interpreter.vue'
import SymbolPalette from '@/components/SymbolPalette.vue'
import { ref, computed } from 'vue'

const userInput = ref('')
const addToInput = (formulaText) => {
  userInput.value += ' ' + formulaText + '()'
}
const interpretedContent = computed(() => {
  return userInput.value
})
const handleDelete = (event) => {
  const input = userInput.value
  const cursorPos = event.target.selectionStart

  // Formules complexes littérales (exactes)
  const complexFormulas = [
    '∫_┤^┤(┤)()',
    '∮_┤^┤(┤)()',
    '∯_┤^┤(┤)()',
    '̅()',
    '|┤|()',
    '⌊┤|┤|()',
    '‖┤‖()'
  ]

  for (let formula of complexFormulas) {
    const start = cursorPos - formula.length
    const fragment = input.slice(start, cursorPos)
    if (fragment === formula) {
      userInput.value = input.slice(0, start) + input.slice(cursorPos)
      event.preventDefault()
      return
    }
  }

  // Cas encadrants dynamiques : |x|, ‖x‖, ⌊x⌋, etc.
  const delimiters = [
    { open: '⌊', close: '⌋' },
    { open: '|', close: '|' },
    { open: '‖', close: '‖' }
  ]

  for (let { open, close } of delimiters) {
    // On cherche les 2 symboles + ()
    const pattern = new RegExp(`\\${open}[^\\${open}\\${close}]*\\${close}\\(\\)`, 'g')

    const matches = [...input.matchAll(pattern)]

    for (let match of matches) {
      const matchStart = match.index
      const matchEnd = matchStart + match[0].length

      if (cursorPos === matchEnd) {
        userInput.value = input.slice(0, matchStart) + input.slice(matchEnd)
        event.preventDefault()
        return
      }
    }
  }

  // Formules simples type xyz()
  const simpleFormulaPattern = /[\ẇ̈^_+=\-*/→‖⌊⌋|∞∅ℕℤℚℝℂ≈≠≤≥]+\(.*?\)/g
  let match
  const startToCursor = input.slice(0, cursorPos)
  while ((match = simpleFormulaPattern.exec(startToCursor)) !== null) {
    const matchStart = match.index
    const matchEnd = match.index + match[0].length
    if (cursorPos === matchEnd) {
      userInput.value = input.slice(0, matchStart) + input.slice(matchEnd)
      event.preventDefault()
      return
    }
  }
}
</script>

<style scoped>
textarea {
  width: 100%;
  margin-bottom: 20px;
  background-color: white;
  color: #333333;
  border: 1px solid black;
  padding: 10px;
  font-size: 14px;
}
</style>
